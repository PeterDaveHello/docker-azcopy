---

dist: focal

services:
  - docker

stages:
  - Static test
  - Build test

jobs:
  include:
    - stage: Static test
      env:
        - Test: hadolint
      language: minimal
      script:
        - docker run -i -v $PWD/.hadolint.yml:/.hadolint.yml hadolint/hadolint < Dockerfile

    - stage: Static test
      env:
        - Test: dockerfile_lint
      language: node_js
      node_js:
        - "12"
      script:
        - npx --cache .npx dockerfile_lint
      cache:
        directories:
          - .npx

    - stage: Build test
      env:
        secure: ny4xWYzirn3MBJdjwAVcdXjl8s1hu3viz2MRNe733qY+6S/63FsEEtw/IMNYKVrENhl7Z7gn9m1Phd4bwi0//hdd5GmtMeXV+6tdADm4Vcctl0IZiUDSdFzCHM1Y6sO2k+0VuPh/ctdmOBfG9MXUdvIED5zjR/LKCJOQ9jVC2mz1DH7Ax4U9KywF4gzbMERwGx8rQzVlH81B/1s+GMUmouX5IvPSe8UTd6iGgCwNZ+JhQ7pB6E72blA/Ro25GJ3HdqZoF6QxYh8YTs4a0b8wj738jyuQX4rTPvH7wx1cX+IHhEFelUo3MEtZpyBtwHzcaCdtNfzN0VRNCcne25IPxF3hXErazln6UL1sWFENTqKj1z4146iUgGePp8Sr6Q4FcKjeySq7t+WRwZTYe4d0rTzU/hK5vKkvCwoy+BaqEXIxFFwcoI6BoMzGSSWRwmpwz31E7hQwgubIROMHY0QZRTLLnNBpVPCf18Iy6uH76fAEO2RnN/yIQINts3V4tAGz1xfaQiMblO9N8JB0Ltll+cRAkhux4lbZqQxEqTe/LbSRVk63NNHYHhp4hfj8ldtpZkCNJm46Rmif3QbZHrEbYU2GVpJNzrjwU285YGhJjeCjeYW+I66FKoaWrUufeIQABVtj+gNTzYtv5nLQOsZoDpTTk9Y/Bw4SEA0UKmQWz5I=
      language: minimal
      before_script:
        - if [[ "$TRAVIS_TAG" =~ ^[0-9]+(\.[0-9]+){2}$ ]]; then
            AZCOPY_VERSION="$TRAVIS_TAG";
          else
            AZCOPY_VERSION=$(curl -sLo- https://api.github.com/repos/Azure/azure-storage-azcopy/releases | grep tag_name | head -n 1 | awk -F'"' '{print $4}' | sed 's/^v//g');
          fi
        - echo "$AZCOPY_VERSION"
        - tag=($(echo $AZCOPY_VERSION | tr "." " "))
      script:
        - if [ "$TRAVIS_PULL_REQUEST" = "true" ] || [ "$TRAVIS_BRANCH" != "master" ]; then
            docker build --build-arg AZCOPY_VERSION="$AZCOPY_VERSION" -t docker-azcopy:$TRAVIS_COMMIT .;
            docker run docker-azcopy:$TRAVIS_COMMIT azcopy --version;
          else
            mkdir -p ~/.docker/cli-plugins;
            wget -O ~/.docker/cli-plugins/docker-buildx https://github.com/docker/buildx/releases/download/v0.5.1/buildx-v0.5.1.linux-amd64;
            chmod a+x ~/.docker/cli-plugins/docker-buildx;
            docker run --privileged multiarch/qemu-user-static --reset -p yes;
            docker buildx create --use --name mybuilder;
            docker login -u ${DOCKER_USERNAME} -p ${DOCKER_PASSWORD};
            travis_wait 30 docker buildx build --build-arg AZCOPY_VERSION="$AZCOPY_VERSION" -t $DOCKER_USERNAME/docker-azcopy:latest --platform linux/amd64,linux/arm64 --push .;
          fi
        - if [[ "$TRAVIS_TAG" =~ ^[0-9]+(\.[0-9]+){2}$ ]]; then
            docker buildx build --build-arg AZCOPY_VERSION="$AZCOPY_VERSION" -t $DOCKER_USERNAME/docker-azcopy:$AZCOPY_VERSION -t $DOCKER_USERNAME/docker-azcopy:${tag[0]}.${tag[1]} -t $DOCKER_USERNAME/docker-azcopy:${tag[0]} --platform linux/amd64,linux/arm64 --push .;
          fi
